<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de CSV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/telemont.ico') }}">
    <style>
        .container { max-width: 800px; }
        .upload-box { border: 2px dashed #ccc; padding: 2rem; text-align: center; }
        .file-info { margin-top: 10px; font-size: 0.9em; color: #666; }
        .validation-result { margin-top: 15px; padding: 10px; border-radius: 5px; }
        .validation-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .validation-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .validation-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .colunas-lista { max-height: 150px; overflow-y: auto; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12 text-center">
                <img src="{{ url_for('static', filename='img/telemont.png') }}" alt="Logo Telemont" class="img-fluid p-3" style="width: 300px; display: block; margin: 0px auto;">
                <h1 class="mb-4">üîÑ Conversor de CSV</h1>
                <p class="lead">Converta Enderecos_Totais_CO.csv para formato Power Query</p>
                <a href="/" class="btn btn-secondary mb-4">
                    <i class="fas fa-arrow-left"></i> Voltar ao In√≠cio
                </a>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="upload-box rounded-3">
                    <form method="POST" enctype="multipart/form-data" id="uploadForm">
                        <div class="mb-3">
                            <label for="file" class="form-label">Selecione o arquivo Enderecos_Totais_CO.csv:</label>
                            <input class="form-control" type="file" name="file" id="file" accept=".csv" required>
                            <div class="file-info" id="fileInfo">
                                üìÅ Tamanho m√°ximo: 2GB | Formato: CSV com separador |
                            </div>
                            
                            <!-- Resultado da Valida√ß√£o -->
                            <div id="validationResult" class="validation-result" style="display: none;">
                                <div id="validationContent"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            üîÑ Converter Arquivo
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="row mt-4">
                    <div class="col-12">
                        {% for message in messages %}
                            <div class="alert alert-info alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>‚ÑπÔ∏è Informa√ß√µes do Conversor</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Este conversor realiza as seguintes opera√ß√µes:</strong></p>
                        <ul>
                            <li>Formata CEP e COD_LOGRADOURO</li>
                            <li>Cria CHAVE LOG para agrupamento</li>
                            <li>Processa COMPLEMENTO3 com numera√ß√£o autom√°tica</li>
                            <li>Adiciona informa√ß√µes de roteiro</li>
                            <li>Gera valida√ß√µes dos dados</li>
                            <li>Formata para Power Query (UTF-8 com BOM)</li>
                        </ul>
                        
                        <p><strong>Colunas obrigat√≥rias no CSV:</strong></p>
                        <div class="colunas-lista">
                            <ul class="list-unstyled">
                                {% for coluna in [
                                    'CELULA', 'ESTACAO_ABASTECEDORA', 'UF', 'MUNICIPIO', 'LOCALIDADE', 
                                    'COD_LOCALIDADE', 'LOCALIDADE_ABREV', 'LOGRADOURO', 'COD_LOGRADOURO', 
                                    'NUM_FACHADA', 'COMPLEMENTO', 'COMPLEMENTO2', 'COMPLEMENTO3', 'CEP', 
                                    'BAIRRO', 'COD_SURVEY', 'QUANTIDADE_UMS', 'COD_VIABILIDADE', 
                                    'TIPO_VIABILIDADE', 'TIPO_REDE', 'UCS_RESIDENCIAIS', 'UCS_COMERCIAIS', 
                                    'NOME_CDO', 'ID_ENDERECO', 'LATITUDE', 'LONGITUDE', 'TIPO_SURVEY', 
                                    'REDE_INTERNA', 'UMS_CERTIFICADAS', 'REDE_EDIF_CERT', 'DISP_COMERCIAL', 
                                    'ESTADO_CONTROLE', 'DATA_ESTADO_CONTROLE', 'ID_CELULA', 'QUANTIDADE_HCS'
                                ] %}
                                    <li><code>{{ coluna }}</code></li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <p><strong>Arquivo de entrada:</strong> Enderecos_Totais_CO.csv (separador |)</p>
                        <p><strong>Arquivo de sa√≠da:</strong> CSV formatado para Power Query (separador ;)</p>
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Para arquivos grandes (760MB+):</strong>
                            <ul class="mb-0">
                                <li>O processamento pode levar v√°rios minutos</li>
                                <li>Recomendado para servidores com boa mem√≥ria RAM</li>
                                <li>Ser√° processado em partes para otimizar performance</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Elementos da p√°gina
    const fileInput = document.getElementById('file');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('submitBtn');
    const validationResult = document.getElementById('validationResult');
    const validationContent = document.getElementById('validationContent');

    // Criar elemento de loading
    const loadingSpinner = document.createElement('div');
    loadingSpinner.id = 'loadingSpinner';
    loadingSpinner.style.cssText = `
        display: none;
        text-align: center;
        padding: 10px;
        margin: 10px 0;
    `;
    
    const spinnerHTML = `
        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span style="margin-left: 10px; color: #3498db;">Validando arquivo...</span>
        <div style="font-size: 12px; color: #666; margin-top: 5px;" id="loadingTime">Tempo: 0s</div>
    `;
    
    loadingSpinner.innerHTML = spinnerHTML;
    
    // Adicionar estilo de anima√ß√£o
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    
    // Inserir o spinner ap√≥s o fileInfo
    fileInfo.parentNode.insertBefore(loadingSpinner, fileInfo.nextSibling);

    // Vari√°veis para o temporizador
    let validationTimer;
    let seconds = 0;

    // Fun√ß√£o para iniciar o temporizador
    function startTimer() {
        seconds = 0;
        const timeElement = document.getElementById('loadingTime');
        timeElement.textContent = `Tempo: 0s`;
        
        validationTimer = setInterval(() => {
            seconds++;
            timeElement.textContent = `Tempo: ${seconds}s`;
        }, 1000);
        
        loadingSpinner.style.display = 'block';
    }

    // Fun√ß√£o para parar o temporizador
    function stopTimer() {
        if (validationTimer) {
            clearInterval(validationTimer);
            validationTimer = null;
        }
        loadingSpinner.style.display = 'none';
    }

    // Fun√ß√£o para mostrar resultado da valida√ß√£o
    function showValidationResult(result) {
        validationResult.style.display = 'block';
        
        if (result.valido) {
            validationResult.className = 'validation-result validation-success';
            let html = `<strong>‚úÖ Arquivo v√°lido!</strong><br>`;
            html += `${result.total_colunas} - Colunas encontradas<br>`;
            if (result.colunas_extras && result.colunas_extras.length > 0) {
                html += `<small>Colunas extras: ${result.colunas_extras.join(', ')}</small>`;
            }
            validationContent.innerHTML = html;
            submitBtn.disabled = false;
        } else {
            validationResult.className = 'validation-result validation-error';
            let html = `<strong>‚ùå Arquivo inv√°lido!</strong><br>`;
            if (result.erro) {
                html += `Erro: ${result.erro}`;
            } else {
                html += `Colunas faltantes: ${result.colunas_faltantes.join(', ')}<br>`;
                html += `Total de colunas no arquivo: ${result.total_colunas}`;
            }
            validationContent.innerHTML = html;
            submitBtn.disabled = true;
        }
    }

    // Fun√ß√£o para validar tamanho do arquivo
    function validarTamanhoArquivo(file) {
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        const fileSizeGB = (file.size / (1024 * 1024 * 1024)).toFixed(2);
        
        // Definir limites de tamanho
        const LIMITE_PEQUENO = 5; // 5MB
        const LIMITE_GRANDE = 100; // 100MB
        const LIMITE_MAXIMO = 2 * 1024; // 2GB
        
        if (file.size > LIMITE_MAXIMO * 1024 * 1024) {
            return {
                valido: false,
                tipo: 'tamanho',
                mensagem: `‚ùå Arquivo muito grande! Tamanho: ${fileSizeGB} GB (M√°ximo: 2GB)`
            };
        } else if (file.size > LIMITE_GRANDE * 1024 * 1024) {
            return {
                valido: true,
                tipo: 'tamanho',
                mensagem: `‚ö†Ô∏è Arquivo grande: ${fileSizeMB} MB. A convers√£o pode demorar.`
            };
        } else if (file.size < LIMITE_PEQUENO * 1024 * 1024) {
            return {
                valido: true,
                tipo: 'tamanho',
                mensagem: `üìÑ Arquivo pequeno: ${fileSizeMB} MB. Processamento r√°pido.`
            };
        } else {
            return {
                valido: true,
                tipo: 'tamanho',
                mensagem: `üìä Arquivo de tamanho moderado: ${fileSizeMB} MB.`
            };
        }
    }

    // Fun√ß√£o para validar estrutura do arquivo via AJAX
    function validarEstruturaArquivo(file) {
        const formData = new FormData();
        formData.append('file', file);

        return fetch('/validar-csv', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            return {
                valido: data.valido,
                tipo: 'estrutura',
                dados: data
            };
        })
        .catch(error => {
            console.error('Erro na valida√ß√£o:', error);
            return {
                valido: false,
                tipo: 'estrutura',
                dados: {
                    valido: false,
                    erro: 'Erro ao validar estrutura do arquivo'
                }
            };
        });
    }

    // Fun√ß√£o para atualizar informa√ß√µes do arquivo
    function atualizarFileInfo(mensagem, classe = '') {
        if (classe) {
            fileInfo.innerHTML = `<span class="${classe}">${mensagem}</span>`;
        } else {
            fileInfo.innerHTML = mensagem;
        }
    }

    // Event listener para mudan√ßa de arquivo
    fileInput.addEventListener('change', async function(e) {
        validationResult.style.display = 'none';
        submitBtn.disabled = true;
        stopTimer(); // Parar qualquer timer anterior
        
        if (this.files && this.files[0]) {
            const file = this.files[0];
            
            // Iniciar o temporizador e mostrar spinner
            startTimer();
            
            // Primeira valida√ß√£o: Estrutura do CSV
            atualizarFileInfo('üîç Validando estrutura do arquivo CSV...', 'text-warning');
            
            try {
                // Validar estrutura (colunas)
                const resultadoEstrutura = await validarEstruturaArquivo(file);
                
                // Parar o temporizador ap√≥s a valida√ß√£o
                stopTimer();
                
                if (!resultadoEstrutura.valido) {
                    // Se a estrutura for inv√°lida, mostrar erro e parar aqui
                    showValidationResult(resultadoEstrutura.dados);
                    atualizarFileInfo(`üìÅ ${file.name} - Estrutura inv√°lida`, 'text-danger');
                    return;
                }
                
                // Segunda valida√ß√£o: Tamanho do arquivo (s√≥ se a estrutura for v√°lida)
                const resultadoTamanho = validarTamanhoArquivo(file);
                
                // Mostrar resultado da valida√ß√£o de estrutura
                showValidationResult(resultadoEstrutura.dados);
                
                // Atualizar informa√ß√µes do arquivo com resultado do tamanho
                const infoBase = `üìÅ Arquivo: ${file.name}`;
                if (resultadoTamanho.valido) {
                    atualizarFileInfo(`${infoBase} | ${resultadoTamanho.mensagem}`, 
                                   resultadoTamanho.mensagem.includes('‚ö†Ô∏è') ? 'text-warning' : 'text-success');
                } else {
                    atualizarFileInfo(`${infoBase} | ${resultadoTamanho.mensagem}`, 'text-danger');
                    submitBtn.disabled = true;
                }
                
            } catch (error) {
                // Parar o temporizador em caso de erro
                stopTimer();
                
                console.error('Erro no processo de valida√ß√£o:', error);
                atualizarFileInfo('‚ùå Erro durante a valida√ß√£o do arquivo', 'text-danger');
                showValidationResult({
                    valido: false,
                    erro: 'Falha no processo de valida√ß√£o'
                });
            }
            
        } else {
            atualizarFileInfo('üìÅ Tamanho m√°ximo: 2GB | Formato: CSV com separador |');
            submitBtn.disabled = true;
        }
    });

    // Prevenir envio se o bot√£o estiver desabilitado
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        if (submitBtn.disabled) {
            e.preventDefault();
            alert('Por favor, selecione um arquivo CSV v√°lido antes de converter.');
        }
    });

    // Parar o timer se o usu√°rio mudar de p√°gina ou fechar
    window.addEventListener('beforeunload', function() {
        stopTimer();
    });
</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>